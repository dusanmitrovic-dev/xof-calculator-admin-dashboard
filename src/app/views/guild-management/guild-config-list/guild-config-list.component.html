<c-container fluid>
  <c-row>
    <c-col xs="12">
      <!-- Message shown when NO guild is selected -->
      <c-alert color="info" *ngIf="!(selectedGuildId$ | async)">
        Please select a guild from the dropdown in the header to manage its configuration.
      </c-alert>

      <!-- Main content area shown ONLY when a guild is selected -->
      <ng-container *ngIf="currentGuildId">
        <!-- Guild Configuration Section -->
        <c-card class="mb-4 shadow-sm hover-shadow">
          <c-card-header>
            <strong>Guild Configuration for {{ currentGuildId }}</strong>
            <div class="float-end">
                <button cButton color="danger" variant="outline" size="sm" class="ms-2" (click)="deleteGuildConfig()" [disabled]="loadingConfig || !guildConfig" title="Delete Entire Guild Config">
                   <svg cIcon name="cilTrash" size="sm"></svg> Delete Config
                </button>
            </div>
          </c-card-header>
          <c-card-body>
             <!-- Loading State -->
             <div *ngIf="loadingConfig" class="text-center py-3"><c-spinner aria-hidden="true" size="sm"></c-spinner> Loading Configuration...</div>
             <!-- Error State -->
             <c-alert color="danger" *ngIf="!loadingConfig && configError">{{ configError }}</c-alert>
             <!-- No Config Found State -->
             <div *ngIf="!loadingConfig && !configError && !guildConfig" class="text-center py-3">
               No configuration found for this guild.
               <button cButton color="success" variant="ghost" size="sm" class="ms-2" (click)="openEditConfigModal('full')">
                   <svg cIcon name="cilPlus" size="sm"></svg> Create One?
               </button>
             </div>

             <!-- Config Display State (guildConfig is guaranteed non-null here) -->
             <div *ngIf="!loadingConfig && !configError && guildConfig">
                <!-- General Info Card - Only Guild ID, no Modify button -->
                <c-card class="mb-3 shadow-sm">
                  <c-card-header>
                    General Info
                  </c-card-header>
                  <c-card-body>
                    <c-row class="align-items-center">
                      <c-col sm="3" class="fw-semibold text-muted">Guild ID</c-col>
                      <c-col sm="9"><strong>{{ guildConfig.guild_id }}</strong></c-col>
                    </c-row>
                  </c-card-body>
                </c-card>

                <!-- Display Settings Card - Now includes Agency and Bot Name -->
                <c-card class="mb-3 shadow-sm">
                  <c-card-header>
                    Display Settings (Bot, Agency, Behavior)
                    <div class="float-end">
                      <button cButton color="primary" variant="outline" size="sm" (click)="openEditConfigModal('display_settings')" [disabled]="loadingConfig">
                        <svg cIcon name="cilPencil" size="sm"></svg> Modify
                      </button>
                    </div>
                  </c-card-header>
                  <c-card-body>
                    <c-row class="mb-2 border-bottom pb-2 align-items-center">
                      <c-col sm="3" class="fw-semibold text-muted">
                        <svg cIcon name="cil-speech" size="sm" class="me-1"></svg> Agency Name
                      </c-col>
                      <c-col sm="9">
                        {{ guildConfig.display_settings.agency_name || 'Not Set' }}
                      </c-col>
                    </c-row>
                    <c-row class="mb-2 border-bottom pb-2 align-items-center">
                      <c-col sm="3" class="fw-semibold text-muted">
                         <svg cIcon name="cil-speech" size="sm" class="me-1"></svg> Bot Name
                      </c-col>
                      <c-col sm="9">
                         {{ guildConfig.display_settings.bot_name || 'Not Set' }}
                      </c-col>
                    </c-row>
                    <c-row class="mb-2 border-bottom pb-2 align-items-center">
                      <c-col sm="3" class="fw-semibold text-muted">
                        <svg cIcon name="cil-message-square" size="sm" class="me-1"></svg> Ephemeral Responses
                      </c-col>
                      <c-col sm="9">
                        <span class="border rounded py-1 px-2 d-inline-block text-body ms-2" [ngClass]="guildConfig.display_settings.ephemeral_responses ? 'border-success' : 'border-danger'">
                          {{ guildConfig.display_settings.ephemeral_responses ? 'Enabled' : 'Disabled' }}
                        </span>
                      </c-col>
                    </c-row>
                     <c-row class="mb-2 border-bottom pb-2 align-items-center">
                      <c-col sm="3" class="fw-semibold text-muted">
                        <svg cIcon name="cil-chart-line" size="sm" class="me-1"></svg> Show Average
                      </c-col>
                      <c-col sm="9">
                        <span class="border rounded py-1 px-2 d-inline-block text-body ms-2" [ngClass]="guildConfig.display_settings.show_average ? 'border-success' : 'border-danger'">
                          {{ guildConfig.display_settings.show_average ? 'Enabled' : 'Disabled' }}
                        </span>
                      </c-col>
                    </c-row>
                    <c-row class="mb-0 align-items-center">
                      <c-col sm="3" class="fw-semibold text-muted">
                        <svg cIcon name="cil-barcode" size="sm" class="me-1"></svg> Show IDs
                      </c-col>
                      <c-col sm="9">
                        <span class="border rounded py-1 px-2 d-inline-block text-body ms-2" [ngClass]="guildConfig.display_settings.show_ids ? 'border-success' : 'border-danger'">
                          {{ guildConfig.display_settings.show_ids ? 'Enabled' : 'Disabled' }}
                        </span>
                      </c-col>
                    </c-row>
                  </c-card-body>
                </c-card>

                <!-- Basic Definitions Card -->
                <c-card class="mb-3 shadow-sm">
                  <c-card-header>
                    Basic Definitions
                  </c-card-header>
                  <c-card-body>
                    <c-row class="mb-2 border-bottom pb-2 align-items-center">
                      <c-col sm="3" class="fw-semibold text-muted">Models</c-col>
                      <c-col sm="6">
                        <ng-container *ngIf="guildConfig.models && guildConfig.models.length > 0; else noModels">
                          <span *ngFor="let model of guildConfig.models" class="border rounded py-1 px-2 me-1 mb-1 d-inline-block text-body">{{ model }}</span>
                        </ng-container>
                        <ng-template #noModels><span class="text-muted">-</span></ng-template>
                      </c-col>
                      <c-col sm="3" class="text-end">
                        <button cButton color="primary" variant="outline" size="sm" (click)="openEditConfigModal('models')" [disabled]="loadingConfig">
                          <svg cIcon name="cilPencil" size="sm"></svg> Modify
                        </button>
                      </c-col>
                    </c-row>
                    <c-row class="mb-2 border-bottom pb-2 align-items-center">
                      <c-col sm="3" class="fw-semibold text-muted">Shifts</c-col>
                      <c-col sm="6">
                        <ng-container *ngIf="guildConfig.shifts && guildConfig.shifts.length > 0; else noShifts">
                          <span *ngFor="let shift of guildConfig.shifts" class="border rounded py-1 px-2 me-1 mb-1 d-inline-block text-body">{{ shift }}</span>
                        </ng-container>
                        <ng-template #noShifts><span class="text-muted">-</span></ng-template>
                      </c-col>
                      <c-col sm="3" class="text-end">
                        <button cButton color="primary" variant="outline" size="sm" (click)="openEditConfigModal('shifts')" [disabled]="loadingConfig">
                          <svg cIcon name="cilPencil" size="sm"></svg> Modify
                        </button>
                      </c-col>
                    </c-row>
                    <c-row class="mb-0 align-items-center"> 
                      <c-col sm="3" class="fw-semibold text-muted">Periods</c-col>
                      <c-col sm="6">
                        <ng-container *ngIf="guildConfig.periods && guildConfig.periods.length > 0; else noPeriods">
                          <span *ngFor="let period of guildConfig.periods" class="border rounded py-1 px-2 me-1 mb-1 d-inline-block text-body">{{ period }}</span>
                        </ng-container>
                        <ng-template #noPeriods><span class="text-muted">-</span></ng-template>
                      </c-col>
                      <c-col sm="3" class="text-end">
                        <button cButton color="primary" variant="outline" size="sm" (click)="openEditConfigModal('periods')" [disabled]="loadingConfig">
                          <svg cIcon name="cilPencil" size="sm"></svg> Modify
                        </button>
                      </c-col>
                    </c-row>
                  </c-card-body>
                </c-card>

                <!-- Bonus Rules Card -->
                <c-card class="mb-3 shadow-sm">
                  <c-card-header>
                    Bonus Rules
                    <div class="float-end">
                      <button cButton color="primary" variant="outline" size="sm" (click)="openEditConfigModal('bonus_rules')" [disabled]="loadingConfig">
                        <svg cIcon name="cilPencil" size="sm"></svg> Modify
                      </button>
                    </div>
                  </c-card-header>
                  <c-card-body>
                    @if (guildConfig.bonus_rules && guildConfig.bonus_rules.length > 0) {
                      <table class="table table-striped mb-0">
                        <thead>
                          <tr>
                            <th scope="col">#</th>
                            <th scope="col">Minimum Revenue</th>
                            <th scope="col">Maximum Revenue</th>
                            <th scope="col">Bonus Amount</th>
                          </tr>
                        </thead>
                        <tbody>
                          @for (rule of guildConfig.bonus_rules; track $index) {
                            <tr>
                              <th scope="row">{{ $index + 1 }}</th>
                              <td>{{ rule.from | currency }}</td>
                              <td>{{ rule.to | currency }}</td>
                              <td>{{ rule.amount | currency }}</td>
                            </tr>
                          }
                        </tbody>
                      </table>
                    } @else {
                      <div class="text-center text-muted py-3">
                        <svg cIcon name="cilBan" size="xl" class="mb-2"></svg>
                        <p>No bonus rules defined.</p>
                      </div>
                    }
                  </c-card-body>
                </c-card>

                <!-- Top-Level Roles Card -->
                <c-card class="mb-3 shadow-sm">
                  <c-card-header>
                    General Role Settings (Numeric Values)
                    <div class="float-end">
                      <button cButton color="primary" variant="outline" size="sm" (click)="openEditConfigModal('top_level_roles')" [disabled]="loadingConfig">
                        <svg cIcon name="cilTags" size="sm"></svg> Modify
                      </button>
                    </div>
                  </c-card-header>
                  <c-card-body>
                    @if (guildConfig.roles && objectKeys(guildConfig.roles).length > 0) {
                      <table class="table table-striped mb-0">
                        <thead>
                          <tr>
                            <th scope="col">#</th>
                            <th scope="col">Role ID</th>
                            <th scope="col">Value</th>
                          </tr>
                        </thead>
                        <tbody>
                          @for (roleId of objectKeys(guildConfig.roles); track $index) {
                            <tr>
                              <th scope="row">{{ $index + 1 }}</th>
                              <td><code>{{ roleId }}</code></td>
                              <td><strong>{{ guildConfig.roles[roleId] }}</strong></td>
                            </tr>
                          }
                        </tbody>
                      </table>
                    } @else {
                      <div class="text-center text-muted py-3">
                        <svg cIcon name="cilBan" size="xl" class="mb-2"></svg>
                        <p>No general role settings defined.</p>
                      </div>
                    }
                  </c-card-body>
                </c-card>

                <!-- Role Commissions Card -->
                <c-card class="mb-3 shadow-sm">
                  <c-card-header>
                    Role Commissions
                    <div class="float-end">
                      <button cButton color="primary" variant="outline" size="sm" (click)="openEditConfigModal('commission_settings_roles')" [disabled]="loadingConfig">
                        <svg cIcon name="cilPencil" size="sm"></svg> Modify
                      </button>
                    </div>
                  </c-card-header>
                  <c-card-body>
                    @if (guildConfig.commission_settings && guildConfig.commission_settings.roles && objectKeys(guildConfig.commission_settings.roles).length > 0) {
                      <ul class="list-unstyled mb-0">
                        @for (roleId of objectKeys(guildConfig.commission_settings.roles); track roleId) {
                          <li class="border-bottom pb-2 mb-2">
                             Role ID <code>{{ roleId }}</code>: <strong>{{ guildConfig.commission_settings.roles[roleId].commission_percentage }}%</strong>
                          </li>
                        }
                      </ul>
                    } @else {
                      <div class="text-center text-muted py-3">
                        <svg cIcon name="cilUserX" size="xl" class="mb-2"></svg>
                        <p>No role-specific commissions defined.</p>
                      </div>
                    }
                  </c-card-body>
                </c-card>

                <!-- User Overrides Card -->
                <c-card class="mb-3 shadow-sm">
                  <c-card-header>
                    User Overrides
                    <div class="float-end">
                      <button cButton color="primary" variant="outline" size="sm" (click)="openEditConfigModal('commission_settings_users')" [disabled]="loadingConfig">
                        <svg cIcon name="cilPencil" size="sm"></svg> Modify
                      </button>
                    </div>
                  </c-card-header>
                  <c-card-body>
                    @if (guildConfig.commission_settings && guildConfig.commission_settings.users && objectKeys(guildConfig.commission_settings.users).length > 0) {
                      <ul class="list-unstyled mb-0">
                        @for (userId of objectKeys(guildConfig.commission_settings.users); track userId) {
                          <li class="border-bottom pb-2 mb-2">
                             User ID <code>{{ userId }}</code>:
                             @if (guildConfig.commission_settings.users[userId].hourly_rate != null) {
                               <span class="ms-2"> Hourly Rate: <strong>{{ guildConfig.commission_settings.users[userId].hourly_rate | currency }}</strong></span>
                             }
                             @if (guildConfig.commission_settings.users[userId].override_role) {
                               <span class="border rounded py-1 px-2 d-inline-block text-body ms-2">Overrides Role %</span>
                             }
                          </li>
                        }
                      </ul>
                    } @else {
                      <div class="text-center text-muted py-3">
                        <svg cIcon name="cilUserUnfollow" size="xl" class="mb-2"></svg>
                        <p>No user-specific overrides defined.</p>
                      </div>
                    }
                  </c-card-body>
                </c-card>

             </div>
          </c-card-body>
        </c-card>

      </ng-container>
    </c-col>
  </c-row>
</c-container>

<!-- Guild Config Edit Modal -->
@if (isConfigEditModalVisible && currentGuildId) {
  <app-guild-config-edit-modal
    [(visible)]="isConfigEditModalVisible"
    [guildId]="currentGuildId"
    [guildConfig]="guildConfig"
    [editSection]="currentEditSection"
    (configSaved)="onConfigSaved($event)">
  </app-guild-config-edit-modal>
}
