<c-row>
  <c-col xs="12">
    <!-- Message shown when NO guild is selected -->
    <c-alert color="info" *ngIf="!(selectedGuildId$ | async)">
      Please select a guild from the dropdown in the header to manage its earnings records.
    </c-alert>

    <!-- Main content area shown ONLY when a guild is selected -->
    <ng-container *ngIf="currentGuildId">
      <c-card class="mb-4">
        <c-card-header>
          <strong>Earnings Records for {{ currentGuildId }}</strong>
          <div class="float-end">
            <button cButton color="success" variant="outline" size="sm" (click)="openAddEarningModal()" 
                    [disabled]="loadingEarnings || loadingConfig || !guildConfig" 
                    title="{{ !guildConfig ? 'Guild Config must exist first' : 'Add New Earning' }}">
              <svg cIcon name="cilPlus" size="sm"></svg> Add Earning
            </button>
          </div>
        </c-card-header>
        <c-card-body>
          <!-- Loading states -->
          <div *ngIf="loadingConfig || loadingEarnings" class="text-center py-3">
            <c-spinner aria-hidden="true" size="sm"></c-spinner> 
            {{ loadingConfig ? 'Loading guild configuration...' : 'Loading earnings...' }}
          </div>

          <!-- Error State for Earnings -->
          <c-alert color="danger" *ngIf="!loadingEarnings && earningsError && !loadingConfig">
            {{ earningsError }}
          </c-alert>
          
          <!-- No Guild Config State -->
          <div *ngIf="!loadingConfig && !guildConfig && currentGuildId && !earningsError" class="text-center py-3 text-muted">
              <svg cIcon name="cilSettings" size="xxl" class="text-warning mb-2"></svg>
              <h5 class="text-warning">Guild Configuration Missing</h5>
              <p>A guild configuration must exist for guild <strong>{{ currentGuildId }}</strong> before earnings can be managed or recorded.</p>
              <p>Please go to <a routerLink="/guild-configurations">Guild Configurations</a> to set one up.</p>
          </div>

          <!-- No Earnings Found State (but config exists) -->
          <div *ngIf="!loadingConfig && guildConfig && !loadingEarnings && !earningsError && earnings.length === 0" class="text-center py-3">
            <c-card class="shadow-sm">
              <c-card-body class="text-center">
                <svg cIcon name="cilInbox" size="xxl" class="text-muted mb-2"></svg>
                <h5 class="card-title">No earnings recorded yet for {{ currentGuildId }}.</h5>
                <p class="card-text">Click <strong>“Add Earning”</strong> to get started.</p>
                <button cButton color="success" (click)="openAddEarningModal()" [disabled]="!guildConfig">
                  <svg cIcon name="cilPlus" size="sm" class="me-1"></svg>Add Earning
                </button>
              </c-card-body>
            </c-card>
          </div>

          <!-- Earnings Table -->
          <ng-container *ngIf="!loadingConfig && guildConfig && !loadingEarnings && !earningsError && earnings.length > 0">
            <table cTable class="mb-0 border" hover responsive striped align="middle">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>User</th>
                  <th>Role</th>
                  <th>Model</th> <!-- Changed Header from Model(s) to Model -->
                  <th>Shift</th>
                  <th>Period</th>
                  <th>Hours</th>
                  <th>Gross Rev.</th>
                  <th>Total Cut</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <!-- --- UPDATED: Use trackBy: trackById --- -->
                <tr *ngFor="let earning of earnings; trackBy: trackById">
                <!-- --- END UPDATE --- -->
                  <td>{{ earning.date }}</td>
                  <td>{{ earning.user_mention }}</td>
                  <td>{{ earning.role }}</td>
                  <td> <!-- Updated column display -->
                    <span *ngIf="earning.models" class="badge bg-secondary">{{ earning.models }}</span>
                    <span *ngIf="!earning.models">-</span>
                  </td>
                  <td>{{ earning.shift }}</td>
                  <td>{{ earning.period }}</td>
                  <td>{{ earning.hours_worked }}</td>
                  <td>{{ earning.gross_revenue | currency }}</td>
                  <td>{{ earning.total_cut | currency }}</td>
                  <td>
                    <button cButton color="primary" variant="outline" size="sm" (click)="openEditEarningModal(earning)" title="Edit Earning">
                      <svg cIcon name="cilPencil" size="sm"></svg>
                    </button>
                    <button cButton color="danger" variant="outline" size="sm" class="ms-1" (click)="deleteEarning(earning)" title="Delete Earning">
                      <svg cIcon name="cilTrash" size="sm"></svg>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </ng-container>
        </c-card-body>
      </c-card>
    </ng-container>
  </c-col>
</c-row>

<!-- Earning Add/Edit Modal -->
<app-earning-edit-modal *ngIf="isEarningModalVisible && currentGuildId"
  [(visible)]="isEarningModalVisible"
  [guildId]="currentGuildId!" 
  [guildConfig]="guildConfig" 
  [earningToEdit]="selectedEarningForEdit" 
  (earningSaved)="onEarningSaved($event)">
</app-earning-edit-modal>
