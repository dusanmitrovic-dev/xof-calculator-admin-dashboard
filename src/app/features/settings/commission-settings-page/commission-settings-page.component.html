<div class="page-container">
  <!-- <h1>Commission Settings</h1> -->

  <form [formGroup]="commissionForm" novalidate>
    <!-- Roles Card -->
    <app-config-card title="Role Base Commissions" [loading]="isLoading">
      <div card-actions>
        <!-- TODO: Replace button with one that opens the Add Role Dialog -->
        <button mat-stroked-button class="add-role-button" (click)="openAddRoleDialog()" [disabled]="isLoading">
          <mat-icon>add</mat-icon> Add Role
        </button>
        <button
          mat-flat-button
          color="primary"
          (click)="onSubmit()"
          [disabled]="isLoading || commissionForm.pristine || !commissionForm.valid"
          matTooltip="Save Role and User Override settings"
        >
          <mat-icon>save</mat-icon> Save All Changes
        </button>
      </div>
      <div card-content formGroupName="roles">
        <div *ngIf="roleKeys.length === 0 && !isLoading" class="no-data-message">
          No roles defined. Click 'Add Role' to create one.
        </div>

        <div *ngFor="let roleId of roleKeys; trackBy: trackByKey" [formGroupName]="roleId" class="form-row item-row">
          <mat-form-field appearance="outline" class="id-field">
            <mat-label>Role ID</mat-label>
            <!-- Display Role ID - make it copyable -->
            <input matInput [value]="roleId" readonly title="Role ID: {{roleId}}" cdkCopyToClipboard="{{roleId}}" #roleIdInput>
             <button mat-icon-button matSuffix (click)="copyToClipboard(roleIdInput)" matTooltip="Copy Role ID">
                <mat-icon>content_copy</mat-icon>
            </button>
          </mat-form-field>

          <mat-form-field appearance="outline" class="value-field percentage-field">
            <mat-label>Commission %</mat-label>
            <input
              matInput
              type="number"
              formControlName="commission_percentage"
              min="0"
              max="100"
              step="0.1"
              placeholder="e.g., 6.5"
              required
            />
            <mat-error *ngIf="rolesFormGroup.get(roleId)?.get('commission_percentage')?.hasError('required')">
              Percentage is required.
            </mat-error>
            <mat-error *ngIf="rolesFormGroup.get(roleId)?.get('commission_percentage')?.hasError('min') || rolesFormGroup.get(roleId)?.get('commission_percentage')?.hasError('max')">
              Enter a value between 0 and 100.
            </mat-error>
          </mat-form-field>

          <button
            mat-icon-button
            color="warn"
            (click)="removeRole(roleId)"
            matTooltip="Delete Role Setting"
            type="button"
            [disabled]="isLoading"
          >
            <mat-icon>delete_outline</mat-icon>
          </button>
        </div>
      </div>
    </app-config-card>

    <mat-divider class="section-divider"></mat-divider>

    <!-- Users Card -->
    <app-config-card title="User Specific Overrides" [loading]="isLoading">
       <div card-actions>
        <!-- TODO: Replace button with one that opens the Add User Override Dialog -->
        <button mat-stroked-button (click)="openAddUserOverrideDialog()" [disabled]="isLoading">
          <mat-icon>person_add</mat-icon> Add User Override
        </button>
         <!-- Save button is already in the Roles card, controls the whole form -->
       </div>
      <div card-content formGroupName="users">
        <div *ngIf="userKeys.length === 0 && !isLoading" class="no-data-message">
          No user-specific overrides defined.
        </div>

        <div *ngFor="let userId of userKeys; trackBy: trackByKey" [formGroupName]="userId" class="form-row item-row user-row">
          <mat-form-field appearance="outline" class="id-field">
            <mat-label>User ID</mat-label>
             <!-- Display User ID - make it copyable -->
            <input matInput [value]="userId" readonly title="User ID: {{userId}}" cdkCopyToClipboard="{{userId}}" #userIdInput>
             <button mat-icon-button matSuffix (click)="copyToClipboard(userIdInput)" matTooltip="Copy User ID">
                <mat-icon>content_copy</mat-icon>
            </button>
          </mat-form-field>

          <mat-form-field appearance="outline" class="value-field rate-field">
            <mat-label>Hourly Rate ($)</mat-label>
            <input
              matInput
              type="number"
              formControlName="hourly_rate"
              min="0"
              step="0.01"
              placeholder="e.g., 4.00"
              required
            />
            <mat-error *ngIf="usersFormGroup.get(userId)?.get('hourly_rate')?.hasError('required')">
              Hourly rate is required.
            </mat-error>
            <mat-error *ngIf="usersFormGroup.get(userId)?.get('hourly_rate')?.hasError('min')">
              Rate must be 0 or greater.
            </mat-error>
          </mat-form-field>



            <!-- Conditionally show Override Commission % field -->
            <mat-form-field
                appearance="outline"
                class="value-field percentage-field override-percentage-field"
                *ngIf="usersFormGroup.get(userId)?.get('override_role')?.value"
            >
                <mat-label>Override Comm. %</mat-label>
                <input
                    matInput
                    type="number"
                    formControlName="commission_percentage"
                    min="0" max="100" step="0.1"
                    placeholder="e.g., 7.0"
                    required
                 />
                 <!-- Validation errors for the override percentage -->
                <mat-error *ngIf="usersFormGroup.get(userId)?.get('commission_percentage')?.hasError('required')">
                    Override percentage is required when enabled.
                </mat-error>
                <mat-error *ngIf="usersFormGroup.get(userId)?.get('commission_percentage')?.hasError('min') || usersFormGroup.get(userId)?.get('commission_percentage')?.hasError('max')">
                    Enter a value between 0 and 100.
                 </mat-error>
            </mat-form-field>

            <mat-slide-toggle
              formControlName="override_role"
              class="override-toggle"
              color="primary"
              matTooltip="Enable to set a specific commission % for this user, ignoring their role's %"
            >
                Override Role?
            </mat-slide-toggle>

          <button
            mat-icon-button
            color="warn"
            (click)="removeUser(userId)"
            matTooltip="Delete User Override"
            type="button"
            [disabled]="isLoading"
          >
            <mat-icon>delete_outline</mat-icon>
          </button>

        </div>
      </div>
    </app-config-card>
  </form>
</div>
