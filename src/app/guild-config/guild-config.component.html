<div class="config-container">
  <h1>Guild Configuration</h1>

  <app-guild-selector (guildSelected)="onGuildSelected($event)"></app-guild-selector>

  @if (isLoading()) {
    <div class="loading-spinner">
       <mat-spinner diameter="50"></mat-spinner>
    </div>
  }

  @if (selectedGuildId() && !isLoading() && configForm.controls && guildConfig()) {
    <mat-card class="config-card">
      <mat-card-header>
        <mat-card-title>Editing Configuration for Guild: {{ selectedGuildId() }}</mat-card-title>
      </mat-card-header>
      <mat-card-content>

        <form [formGroup]="configForm" (ngSubmit)="saveConfig()">

          <mat-accordion multi="true">

            <!-- Models Section -->
            <mat-expansion-panel [expanded]="true"> <!-- Start expanded -->
              <mat-expansion-panel-header>
                <mat-panel-title> <mat-icon>person_pin</mat-icon> Models </mat-panel-title>
                <mat-panel-description> Manage available models </mat-panel-description>
              </mat-expansion-panel-header>
              <div formArrayName="models" class="array-container chips-array-container">
                <label class="array-label">Current Models:</label>
                <mat-chip-listbox aria-label="Model selection">
                   @for (modelControl of models.controls; track $index) {
                      <mat-chip-option class="config-chip">
                        {{ modelControl.value }}
                         <button matChipRemove type="button" (click)="removeItem(models, $index)" matTooltip="Remove Model">
                           <mat-icon>cancel</mat-icon>
                         </button>
                      </mat-chip-option>
                    } @empty {
                       <p class="empty-array-message">No models defined.</p>
                    }
                 </mat-chip-listbox>
                 <div class="add-item-form">
                   <mat-form-field appearance="outline" subscriptSizing="dynamic">
                     <mat-label>New Model</mat-label>
                     <input matInput #modelInput placeholder="Enter model name" (keydown.enter)="addItem(models, modelInput); $event.preventDefault()">
                   </mat-form-field>
                   <button mat-icon-button type="button" (click)="addItem(models, modelInput)" matTooltip="Add Model">
                     <mat-icon color="primary">add_circle</mat-icon>
                   </button>
                 </div>
               </div>
            </mat-expansion-panel>

             <!-- Shifts Section -->
             <mat-expansion-panel>
               <mat-expansion-panel-header>
                 <mat-panel-title> <mat-icon>schedule</mat-icon> Shifts </mat-panel-title>
                 <mat-panel-description> Manage available shifts </mat-panel-description>
               </mat-expansion-panel-header>
                <div formArrayName="shifts" class="array-container chips-array-container">
                 <label class="array-label">Current Shifts:</label>
                 <mat-chip-listbox aria-label="Shift selection">
                   @for (shiftControl of shifts.controls; track $index) {
                      <mat-chip-option class="config-chip">
                        {{ shiftControl.value }}
                         <button matChipRemove type="button" (click)="removeItem(shifts, $index)" matTooltip="Remove Shift">
                           <mat-icon>cancel</mat-icon>
                         </button>
                      </mat-chip-option>
                    } @empty {
                      <p class="empty-array-message">No shifts defined.</p>
                   }
                  </mat-chip-listbox>
                  <div class="add-item-form">
                    <mat-form-field appearance="outline" subscriptSizing="dynamic">
                      <mat-label>New Shift</mat-label>
                      <input matInput #shiftInput placeholder="Enter shift name" (keydown.enter)="addItem(shifts, shiftInput); $event.preventDefault()">
                    </mat-form-field>
                    <button mat-icon-button type="button" (click)="addItem(shifts, shiftInput)" matTooltip="Add Shift">
                      <mat-icon color="primary">add_circle</mat-icon>
                    </button>
                  </div>
                </div>
             </mat-expansion-panel>

             <!-- Periods Section -->
              <mat-expansion-panel>
               <mat-expansion-panel-header>
                 <mat-panel-title> <mat-icon>date_range</mat-icon> Periods </mat-panel-title>
                 <mat-panel-description> Manage available periods </mat-panel-description>
               </mat-expansion-panel-header>
               <div formArrayName="periods" class="array-container chips-array-container">
                <label class="array-label">Current Periods:</label>
                 <mat-chip-listbox aria-label="Period selection">
                   @for (periodControl of periods.controls; track $index) {
                      <mat-chip-option class="config-chip">
                        {{ periodControl.value }}
                         <button matChipRemove type="button" (click)="removeItem(periods, $index)" matTooltip="Remove Period">
                           <mat-icon>cancel</mat-icon>
                         </button>
                      </mat-chip-option>
                    } @empty {
                      <p class="empty-array-message">No periods defined.</p>
                    }
                  </mat-chip-listbox>
                 <div class="add-item-form">
                    <mat-form-field appearance="outline" subscriptSizing="dynamic">
                      <mat-label>New Period</mat-label>
                      <input matInput #periodInput placeholder="Enter period name" (keydown.enter)="addItem(periods, periodInput); $event.preventDefault()">
                    </mat-form-field>
                    <button mat-icon-button type="button" (click)="addItem(periods, periodInput)" matTooltip="Add Period">
                      <mat-icon color="primary">add_circle</mat-icon>
                    </button>
                 </div>
                </div>
             </mat-expansion-panel>

             <!-- Bonus Rules Section -->
             <mat-expansion-panel>
               <mat-expansion-panel-header>
                 <mat-panel-title> <mat-icon>military_tech</mat-icon> Bonus Rules </mat-panel-title>
                 <mat-panel-description> Define bonus tiers based on gross revenue </mat-panel-description>
               </mat-expansion-panel-header>
               <div formArrayName="bonus_rules" class="array-container">
                  <p class="array-label">Define revenue ranges and bonus amounts:</p>
                 @for (ruleGroup of bonus_rules.controls; track $index) {
                   <div [formGroupName]="$index" class="bonus-rule-group">
                     <mat-form-field appearance="outline" subscriptSizing="dynamic">
                       <mat-label>From ($)</mat-label>
                       <input matInput type="number" formControlName="from" required min="0">
                     </mat-form-field>
                     <mat-form-field appearance="outline" subscriptSizing="dynamic">
                       <mat-label>To ($)</mat-label>
                       <input matInput type="number" formControlName="to" required min="0">
                      </mat-form-field>
                      <mat-form-field appearance="outline" subscriptSizing="dynamic">
                       <mat-label>Bonus ($)</mat-label>
                       <input matInput type="number" formControlName="amount" required min="0">
                      </mat-form-field>
                     <button mat-icon-button type="button" color="warn" (click)="removeBonusRule($index)" matTooltip="Remove Bonus Rule">
                       <mat-icon>remove_circle_outline</mat-icon>
                     </button>
                   </div>
                 } @empty {
                    <p class="empty-array-message">No bonus rules defined.</p>
                 }
                 <button mat-stroked-button type="button" (click)="addBonusRule()" class="add-button">
                    <mat-icon>add</mat-icon> Add Bonus Rule
                 </button>
               </div>
             </mat-expansion-panel>

              <!-- Display Settings Section -->
             <mat-expansion-panel>
               <mat-expansion-panel-header>
                 <mat-panel-title> <mat-icon>visibility</mat-icon> Display Settings </mat-panel-title>
                 <mat-panel-description> Control bot appearance and responses </mat-panel-description>
               </mat-expansion-panel-header>
                <div formGroupName="display_settings" class="settings-group">
                  <mat-slide-toggle formControlName="ephemeral_responses">Ephemeral Responses (Replies visible only to user)</mat-slide-toggle>
                  <mat-slide-toggle formControlName="show_average">Show Average in Reports</mat-slide-toggle>
                  <mat-slide-toggle formControlName="show_ids">Show Custom IDs in Bot Output</mat-slide-toggle>
                  <mat-form-field appearance="outline" class="full-width setting-field">
                    <mat-label>Agency Name</mat-label>
                    <input matInput formControlName="agency_name">
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="full-width setting-field">
                    <mat-label>Bot Name</mat-label>
                    <input matInput formControlName="bot_name">
                  </mat-form-field>
                 </div>
             </mat-expansion-panel>

             <!-- Commission Settings Section -->
             <mat-expansion-panel disabled>
               <mat-expansion-panel-header>
                 <mat-panel-title> <mat-icon>percent</mat-icon> Commission Settings </mat-panel-title>
                 <mat-panel-description> Define role/user commissions (Requires dedicated UI) </mat-panel-description>
               </mat-expansion-panel-header>
               <p class="disabled-section-message">Editing Commission Settings needs a more specialized interface (e.g., a table or modal dialog).</p>
             </mat-expansion-panel>

              <!-- Roles Section -->
             <mat-expansion-panel disabled>
               <mat-expansion-panel-header>
                 <mat-panel-title> <mat-icon>group</mat-icon> Role Percentages </mat-panel-title>
                 <mat-panel-description> Define role percentages (Requires dedicated UI) </mat-panel-description>
               </mat-expansion-panel-header>
                <p class="disabled-section-message">Editing Role Percentages needs a more specialized interface.</p>
             </mat-expansion-panel>

          </mat-accordion>

          <div class="save-button-container">
            <button mat-raised-button color="primary" type="submit" [disabled]="configForm.invalid || isSaving() || !configForm.dirty">
                 <!-- Temporarily removed @if/@else for debugging -->
                 <mat-icon>save</mat-icon> Save Configuration 
                 <!-- @if (isSaving()) { -->
                 <!--    <mat-spinner diameter="20" color="accent"></mat-spinner> Saving... -->
                 <!-- } @else { -->
                 <!--    <mat-icon>save</mat-icon> Save Configuration -->
                 <!-- } -->
            </button>
             @if (saveSuccess() === true) {
              <span class="save-status success"><mat-icon>check_circle</mat-icon> Configuration saved!</span>
            }
            @if (saveSuccess() === false && error()) {
               <span class="save-status error"><mat-icon>error</mat-icon> {{ error() }} </span>
            }
             @if (!configForm.dirty && !isSaving()) {
               <span class="save-status info"><mat-icon>info</mat-icon> No changes to save.</span>
            }
          </div>

        </form>

      </mat-card-content>
    </mat-card>
  } @else if (selectedGuildId() && !isLoading() && !guildConfig() && !error()) {
     <p class="info-message">No configuration found for guild {{ selectedGuildId() }}. Default values will be used if you save.</p>
  } @else if (error()) {
     <p class="error-message">{{ error() }}</p>
  } @else if (!selectedGuildId() && !isLoading()) {
    <p class="info-message">Please select a guild above to view or edit its configuration.</p>
  }

</div>