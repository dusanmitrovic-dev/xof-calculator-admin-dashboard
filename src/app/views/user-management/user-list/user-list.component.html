<c-card class="mb-4">
  <c-card-header>
    <strong>User Management</strong>
    <!-- Optional Add User Button -->
  </c-card-header>
  <c-card-body>
    <!-- Use isLoading instead of loading -->
    <div *ngIf="isLoading" class="text-center py-3">
      <c-spinner aria-hidden="true" size="sm"></c-spinner> Loading users...
    </div>

    <c-alert color="danger" *ngIf="errorMessage" dismissible (click)="errorMessage=null">
      {{ errorMessage }}
    </c-alert>

    <!-- Remove async pipe and check users array directly -->
    <ng-container *ngIf="!isLoading && !errorMessage">
      <div *ngIf="users.length === 0" class="alert alert-info">
        No users found.
      </div>

      <table *ngIf="users.length > 0" 
             cTable class="mb-0 border" [hover]="true" [responsive]="true" [striped]="true" align="middle">
        <thead cTableColor="light">
          <tr>
            <th>Email</th>
            <th>Role</th>
            <th>Managed Guilds</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <!-- Iterate over the users array -->
          <tr *ngFor="let user of users">
            <td>
              <div>{{ user.email }}</div>
              <!-- Check if createdAt exists before formatting -->
              <div class="small text-body-secondary">Registered: {{ user.createdAt ? (user.createdAt | date:'short') : 'N/A' }}</div>
            </td>
            <td>
              <!-- Use getRoleBadgeColor method -->
              <c-badge [color]="getRoleBadgeColor(user.role)" shape="rounded-pill">
                {{ user.role | titlecase }}
              </c-badge>
            </td>
            <td>
              <!-- Display logic for different roles -->
              <ng-container *ngIf="user.role === 'admin'"><span class="text-muted">All Guilds</span></ng-container>
              <ng-container *ngIf="user.role === 'manager'">{{ (user.managed_guild_ids && user.managed_guild_ids.length > 0) ? user.managed_guild_ids.join(', ') : 'None Assigned' }}</ng-container>
              <ng-container *ngIf="user.role === 'user'"><span class="text-muted">N/A</span></ng-container>
            </td>
            <td>
              <!-- Ensure c-button-group is imported via ButtonGroupModule -->
              <c-button-group role="group" aria-label="User Actions">
                <button cButton color="primary" variant="outline" size="sm" (click)="openEditUserModal(user)" title="Edit User">
                  <svg cIcon name="cilPencil" size="sm"></svg> Edit
                </button>
                <button cButton color="danger" variant="outline" size="sm" (click)="deleteUser(user)" [disabled]="user._id === currentUserId" title="Delete User">
                  <svg cIcon name="cilTrash" size="sm"></svg> Delete
                </button>
              </c-button-group>
            </td>
          </tr>
        </tbody>
      </table>
    </ng-container>

  </c-card-body>
</c-card>

<!-- User Edit Modal -->
<app-user-edit-modal
  [(visible)]="isUserEditModalVisible"
  [userToEdit]="selectedUserForEdit"
  (userSaved)="onUserSaved($event)"
  (visibleChange)="handleVisibleChange($event)"> <!-- Added visibleChange binding -->
</app-user-edit-modal>
