<h2 mat-dialog-title>{{ isEditMode() ? 'Edit' : 'Add' }} Earning Record</h2>

<mat-dialog-content>
  <form [formGroup]="earningForm">
    <!-- Custom ID (Disabled on Edit) -->
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Custom ID</mat-label>
      <input matInput formControlName="id" required>
       @if (earningForm.get('id')?.hasError('required')) {
        <mat-error>Custom ID is required.</mat-error>
      }
    </mat-form-field>

    <!-- Date -->
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Date</mat-label>
      <input matInput [matDatepicker]="picker" formControlName="date" required>
      <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
      <mat-datepicker #picker></mat-datepicker>
       @if (earningForm.get('date')?.hasError('required')) {
        <mat-error>Date is required.</mat-error>
      }
    </mat-form-field>

    <!-- User Mention -->
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>User Mention</mat-label>
      <input matInput formControlName="user_mention" required placeholder="<@123456789...>">
      @if (earningForm.get('user_mention')?.hasError('required')) {
        <mat-error>User Mention is required.</mat-error>
      }
    </mat-form-field>

    <!-- Gross Revenue -->
    <mat-form-field appearance="outline" class="half-width">
      <mat-label>Gross Revenue ($)</mat-label>
      <input matInput type="number" formControlName="gross_revenue" required min="0">
       @if (earningForm.get('gross_revenue')?.hasError('required')) {
        <mat-error>Gross Revenue is required.</mat-error>
      }
      @if (earningForm.get('gross_revenue')?.hasError('min')) {
        <mat-error>Must be non-negative.</mat-error>
      }
    </mat-form-field>

    <!-- Total Cut -->
    <mat-form-field appearance="outline" class="half-width">
      <mat-label>Total Cut ($)</mat-label>
      <input matInput type="number" formControlName="total_cut" required min="0">
       @if (earningForm.get('total_cut')?.hasError('required')) {
        <mat-error>Total Cut is required.</mat-error>
      }
      @if (earningForm.get('total_cut')?.hasError('min')) {
        <mat-error>Must be non-negative.</mat-error>
      }
    </mat-form-field>

    <!-- Role -->
    <mat-form-field appearance="outline" class="half-width">
      <mat-label>Role</mat-label>
      <mat-select formControlName="role" required>
         @for (role of roles(); track role) {
          <mat-option [value]="role">{{ role }}</mat-option>
        }
        @if (roles().length === 0) {
           <mat-option disabled>No roles defined in config</mat-option>
        }
      </mat-select>
       @if (earningForm.get('role')?.hasError('required')) {
        <mat-error>Role is required.</mat-error>
      }
    </mat-form-field>

    <!-- Shift -->
    <mat-form-field appearance="outline" class="half-width">
      <mat-label>Shift</mat-label>
      <mat-select formControlName="shift" required>
        @for (shift of shifts(); track shift) {
          <mat-option [value]="shift">{{ shift }}</mat-option>
        }
         @if (shifts().length === 0) {
           <mat-option disabled>No shifts defined in config</mat-option>
        }
      </mat-select>
      @if (earningForm.get('shift')?.hasError('required')) {
        <mat-error>Shift is required.</mat-error>
      }
    </mat-form-field>

     <!-- Period -->
    <mat-form-field appearance="outline" class="half-width">
      <mat-label>Period</mat-label>
      <mat-select formControlName="period" required>
        @for (period of periods(); track period) {
          <mat-option [value]="period">{{ period }}</mat-option>
        }
         @if (periods().length === 0) {
           <mat-option disabled>No periods defined in config</mat-option>
        }
      </mat-select>
       @if (earningForm.get('period')?.hasError('required')) {
        <mat-error>Period is required.</mat-error>
      }
    </mat-form-field>

    <!-- Hours Worked -->
    <mat-form-field appearance="outline" class="half-width">
      <mat-label>Hours Worked</mat-label>
      <input matInput type="number" formControlName="hours_worked" required min="0">
      @if (earningForm.get('hours_worked')?.hasError('required')) {
        <mat-error>Hours Worked is required.</mat-error>
      }
       @if (earningForm.get('hours_worked')?.hasError('min')) {
        <mat-error>Must be non-negative.</mat-error>
      }
    </mat-form-field>

     <!-- Models -->
     <mat-form-field appearance="outline" class="full-width">
      <mat-label>Models</mat-label>
      <mat-select formControlName="models" required> <!-- Allow multiple later? -->
         @for (model of models(); track model) {
          <mat-option [value]="model">{{ model }}</mat-option>
        }
         @if (models().length === 0) {
           <mat-option disabled>No models defined in config</mat-option>
        }
      </mat-select>
       @if (earningForm.get('models')?.hasError('required')) {
        <mat-error>Model is required.</mat-error>
      }
    </mat-form-field>

  </form>

   @if (error()) {
      <p class="dialog-error-message">{{ error() }}</p>
    }

</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-stroked-button (click)="cancel()">Cancel</button>
  <button mat-flat-button color="primary" (click)="save()" [disabled]="earningForm.invalid || isSaving()">
    @if (isSaving()) {
        <mat-spinner diameter="20" color="accent" style="margin-right: 8px;"></mat-spinner> Saving...
    } @else {
        {{ isEditMode() ? 'Update' : 'Add' }} Earning
    }
  </button>
</mat-dialog-actions>
