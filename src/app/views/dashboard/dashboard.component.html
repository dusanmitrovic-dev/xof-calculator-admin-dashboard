<c-container fluid>
  <!-- Date Range Filter & Guild Name -->
  <c-row class="mb-3 align-items-center">
    <c-col [md]="selectedGuildName ? 6 : 9"> <!-- Adjust column span based on guild name presence -->
      <h4 *ngIf="selectedGuildName" class="mb-0 guild-name-title">Guild: {{ selectedGuildName }}</h4>
    </c-col>
    <c-col [md]="selectedGuildName ? 6 : 3" class="text-md-start"> <!-- Changed to text-md-start and adjusted span -->
      <c-dropdown class="dashboard-filter-dropdown">
        <button cButton cDropdownToggle color="secondary">
          {{ selectedDateRangeLabel }}
        </button>
        <ul cDropdownMenu>
          <li><a cDropdownItem (click)="setDateRange('7days')">Last 7 Days</a></li>
          <li><a cDropdownItem (click)="setDateRange('30days')">Last 30 Days</a></li>
          <li><a cDropdownItem (click)="setDateRange('90days')">Last 90 Days</a></li>
          <li><a cDropdownItem (click)="setDateRange('365days')">Last Year</a></li> <!-- Added Last Year option -->
          <li><a cDropdownItem (click)="setDateRange('all')">All Time</a></li>
        </ul>
      </c-dropdown>
    </c-col>
  </c-row>

  <!-- Loading Indicator -->
  <div *ngIf="loading" class="d-flex justify-content-center mb-3">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- KPI Cards -->
  <c-row class="mb-4" *ngIf="!loading">
    <c-col [xs]="12" [sm]="6" [lg]="3">
      <div (click)="navigateToMetricDetail('totalGrossRevenue')" style="cursor: pointer;" role="button" [attr.aria-label]="'View details for Total Gross Revenue'">
        <c-widget-stat-a color="info">
          <div class="card-title-container">
            <span class="dashboard-card-title">Total Gross Revenue
              <c-icon name="cilInfo" size="sm" class="ms-1" cTooltip="Represents the total gross revenue generated within the selected date range." tooltipPlacement="top"></c-icon>
            </span>
          </div>
          <div class="card-value-container d-flex align-items-center">
            <c-icon name="cilDollar" size="xl" class="me-2"></c-icon>
            <span class="fs-3 fw-semibold me-2">{{ summaryStats.totalGrossRevenue | currency:'USD':'symbol':'1.2-2' }}</span>
            <ng-container *ngIf="summaryStats.totalGrossRevenueTrend?.trend && summaryStats.totalGrossRevenueTrend?.trend !== 'neutral'">
              <c-icon
                [name]="summaryStats.totalGrossRevenueTrend?.trend === 'up' ? 'cilArrowTop' : 'cilArrowBottom'"
                [class]="'trend-indicator ' + (summaryStats.totalGrossRevenueTrend?.trend === 'up' ? 'positive' : 'negative')"
                class="me-1">
              </c-icon>
              <span [class]="'trend-indicator ' + (summaryStats.totalGrossRevenueTrend?.trend === 'up' ? 'positive' : 'negative')" class="fs-6 fw-semibold">
                {{ summaryStats.totalGrossRevenueTrend?.deltaPercentage }}
              </span>
            </ng-container>
            <span *ngIf="summaryStats.totalGrossRevenueTrend?.trend === 'neutral'" class="trend-indicator neutral">{{ summaryStats.totalGrossRevenueTrend?.deltaPercentage }}</span>
          </div>
        </c-widget-stat-a>
      </div>
    </c-col>
    <c-col [xs]="12" [sm]="6" [lg]="3">
      <div (click)="navigateToMetricDetail('totalCut')" style="cursor: pointer;" role="button" [attr.aria-label]="'View details for Total Cut'">
        <c-widget-stat-a color="info">
           <div class="card-title-container">
            <span class="dashboard-card-title">Total Cut
              <c-icon name="cilCalculator" size="sm" class="ms-1" cTooltip="Represents the total commission earned within the selected date range." tooltipPlacement="top"></c-icon>
            </span>
          </div>
          <div class="card-value-container d-flex align-items-center">
            <c-icon name="cilCalculator" size="xl" class="me-2"></c-icon>
            <span class="fs-3 fw-semibold me-2">{{ summaryStats.totalCut | currency:'USD':'symbol':'1.2-2' }}</span>
            <ng-container *ngIf="summaryStats.totalCutTrend?.trend && summaryStats.totalCutTrend?.trend !== 'neutral'">
              <c-icon [name]="summaryStats.totalCutTrend?.trend === 'up' ? 'cilArrowTop' : 'cilArrowBottom'" [class]="'trend-indicator ' + (summaryStats.totalCutTrend?.trend === 'up' ? 'positive' : 'negative')" class="me-1"></c-icon>
              <span [class]="'trend-indicator ' + (summaryStats.totalCutTrend?.trend === 'up' ? 'positive' : 'negative')" class="fs-6 fw-semibold">{{ summaryStats.totalCutTrend?.deltaPercentage }}</span>
            </ng-container>
             <span *ngIf="!summaryStats.totalCutTrend?.trend || summaryStats.totalCutTrend?.trend === 'neutral'" class="trend-indicator neutral">{{ summaryStats.totalCutTrend?.deltaPercentage }}</span>
          </div>
        </c-widget-stat-a>
      </div>
    </c-col>
    <c-col [xs]="12" [sm]="6" [lg]="3">
      <div (click)="navigateToMetricDetail('totalEntries')" style="cursor: pointer;" role="button" [attr.aria-label]="'View details for Total Entries'">
        <c-widget-stat-a color="info">
           <div class="card-title-container">
            <span class="dashboard-card-title">Total Entries
              <c-icon name="cilInfo" size="sm" class="ms-1" cTooltip="Represents the total number of revenue entries recorded within the selected date range." tooltipPlacement="top"></c-icon>
            </span>
          </div>
          <div class="card-value-container d-flex align-items-center">
            <c-icon name="cilListNumbered" size="xl" class="me-2"></c-icon>
            <span class="fs-3 fw-semibold me-2">{{ summaryStats.totalEntries | number:'1.0-0' }}</span>
            <ng-container *ngIf="summaryStats.totalEntriesTrend?.trend && summaryStats.totalEntriesTrend?.trend !== 'neutral'">
              <c-icon [name]="summaryStats.totalEntriesTrend?.trend === 'up' ? 'cilArrowTop' : 'cilArrowBottom'" [class]="'trend-indicator ' + (summaryStats.totalEntriesTrend?.trend === 'up' ? 'positive' : 'negative')" class="me-1"></c-icon>
              <span [class]="'trend-indicator ' + (summaryStats.totalEntriesTrend?.trend === 'up' ? 'positive' : 'negative')" class="fs-6 fw-semibold">{{ summaryStats.totalEntriesTrend?.deltaPercentage }}</span>
            </ng-container>
            <span *ngIf="!summaryStats.totalEntriesTrend?.trend || summaryStats.totalEntriesTrend?.trend === 'neutral'" class="trend-indicator neutral">{{ summaryStats.totalEntriesTrend?.deltaPercentage }}</span>
          </div>
        </c-widget-stat-a>
      </div>
    </c-col>
    <c-col [xs]="12" [sm]="6" [lg]="3">
      <div (click)="navigateToMetricDetail('avgCutPerEntry')" style="cursor: pointer;" role="button" [attr.aria-label]="'View details for Average Cut per Entry'">
        <c-widget-stat-a color="info">
           <div class="card-title-container">
            <span class="dashboard-card-title">
              Avg Cut per Entry
              <c-icon name="cilChartPie" size="sm" class="ms-1" cTooltip="Represents the average 'total cut' (commission) per individual 'entry' recorded. Calculated as Total Cut / Total Entries." tooltipPlacement="top"></c-icon>
            </span>
          </div>
          <div class="card-value-container d-flex align-items-center">
            <c-icon name="cilChartPie" size="xl" class="me-2"></c-icon>
            <span class="fs-3 fw-semibold me-2">{{ summaryStats.avgCutPerEntry | currency:'USD':'symbol':'1.2-2' }}</span>
            <ng-container *ngIf="summaryStats.avgCutPerEntryTrend?.trend && summaryStats.avgCutPerEntryTrend?.trend !== 'neutral'">
              <c-icon [name]="summaryStats.avgCutPerEntryTrend?.trend === 'up' ? 'cilArrowTop' : 'cilArrowBottom'" [class]="'trend-indicator ' + (summaryStats.avgCutPerEntryTrend?.trend === 'up' ? 'positive' : 'negative')" class="me-1"></c-icon>
              <span [class]="'trend-indicator ' + (summaryStats.avgCutPerEntryTrend?.trend === 'up' ? 'positive' : 'negative')" class="fs-6 fw-semibold">{{ summaryStats.avgCutPerEntryTrend?.deltaPercentage }}</span>
            </ng-container>
            <span *ngIf="!summaryStats.avgCutPerEntryTrend?.trend || summaryStats.avgCutPerEntryTrend?.trend === 'neutral'" class="trend-indicator neutral">{{ summaryStats.avgCutPerEntryTrend?.deltaPercentage }}</span>
          </div>
        </c-widget-stat-a>
      </div>
    </c-col>
  </c-row>

  <!-- Revenue Over Time Chart -->
  <c-row class="mb-4" *ngIf="!loading">
    <c-col>
      <c-card>
        <c-card-header>
          <div class="chart-legend-above">
            Gross Revenue Over Time
          </div>
        </c-card-header>
        <c-card-body>
          <c-chart type="line" [data]="revenueOverTimeChartData" [options]="lineChartOptions"></c-chart>
        </c-card-body>
      </c-card>
    </c-col>
  </c-row>

  <!-- Breakdown Section Placeholder -->
  <c-row class="mb-4" *ngIf="!loading">
    <c-col>
      <c-card>
        <c-card-header>Revenue Breakdown (Top Sources/Entries)</c-card-header>
        <c-card-body>
          <p class="text-medium-emphasis">
            Detailed breakdown of revenue sources or most profitable entries will be displayed here.
            (e.g., Top 5 users by revenue, Top 5 roles by cut). This section will be implemented with actual data in a future update.
          </p>
        </c-card-body>
      </c-card>
    </c-col>
  </c-row>

  <!-- Revenue Entries Table -->
  <c-row class="mb-4" *ngIf="!loading">
    <c-col>
      <c-card>
        <c-card-header>Revenue Entries</c-card-header>
        <c-card-body>
          <c-row class="mb-3">
            <c-col [sm]="8" [md]="9">
              <c-input-group>
                <span cInputGroupText>
                  <c-icon name="cilSearch"></c-icon>
                </span>
                <input cFormControl
                       placeholder="Search entries..."
                       [(ngModel)]="searchTerm"
                       (ngModelChange)="onSearchTermChange()"/>
              </c-input-group>
            </c-col>
            <c-col [sm]="4" [md]="3" class="text-end">
              <button cButton color="secondary" (click)="exportToCsv()">
                <c-icon name="cilSave" class="me-1"></c-icon> Export
              </button>
            </c-col>
          </c-row>

          <div class="table-responsive">
            <table cTable class="table table-striped table-hover">
              <thead>
                <tr>
                  <th scope="col">Date</th>
                  <th scope="col">User</th>
                  <th scope="col">Role</th>
                  <th scope="col">Shift</th>
                  <th scope="col">Revenue</th>
                   <th scope="col">Cut</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let entry of displayableEntries">
                  <td>{{ entry.parsedDate | date:'shortDate' }}</td>
                  <td>{{ entry.user_mention || 'N/A' }}</td>
                  <td>{{ entry.role || 'N/A' }}</td>
                  <td>{{ entry.shift || 'N/A' }}</td>
                  <td>{{ entry.gross_revenue | currency:'USD':'symbol':'1.0-0' }}</td>
                  <td>{{ entry.total_cut | currency:'USD':'symbol':'1.0-0' }}</td>
                </tr>
                <tr *ngIf="displayableEntries.length === 0">
                  <td colspan="6" class="text-center">
                    {{ searchTerm && searchTerm.trim() !== '' ? 'No entries match your search.' : 'No entries found.' }}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <c-pagination
            *ngIf="totalPages > 1"
            align="end"
            aria-label="Table pagination">
            <li cPageItem [disabled]="currentPage === 1">
              <a cPageLink (click)="previousPage()" aria-label="Previous" role="button">
                <span aria-hidden="true">&laquo;</span>
                <span class="visually-hidden">Previous</span>
              </a>
            </li>
            <li cPageItem *ngFor="let pageNum of [].constructor(totalPages); let i = index"
                [active]="currentPage === (i + 1)"
                (click)="goToPage(i + 1)" role="button">
              <a cPageLink>{{ i + 1 }}</a>
            </li>
            <li cPageItem [disabled]="currentPage === totalPages">
              <a cPageLink (click)="nextPage()" aria-label="Next" role="button">
                <span aria-hidden="true">&raquo;</span>
                <span class="visually-hidden">Next</span>
              </a>
            </li>
          </c-pagination>
        </c-card-body>
      </c-card>
    </c-col>
  </c-row>
</c-container>
