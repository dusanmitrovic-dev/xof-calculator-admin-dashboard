<h2 mat-dialog-title>Edit User: {{ data.user.email }}</h2>

<mat-dialog-content>
  <form [formGroup]="userForm">
    <!-- Email (Read-only) -->
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Email</mat-label>
      <input matInput formControlName="email" readonly>
    </mat-form-field>

    <!-- Role Selection -->
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Role</mat-label>
      <mat-select formControlName="role" required>
        <mat-option value="manager">Manager</mat-option>
        <mat-option value="admin">Admin</mat-option>
      </mat-select>
       @if (userForm.get('role')?.hasError('required') && userForm.get('role')?.touched) {
        <mat-error>Role is required.</mat-error>
      }
       @if (userForm.get('role')?.disabled) {
         <mat-hint align="start">Cannot change own role.</mat-hint>
       }
    </mat-form-field>

    <mat-divider></mat-divider>

    <!-- Managed Guilds Selection (Only enabled for Managers) -->
    <h3>Managed Guilds</h3>
    @if (userForm.get('role')?.value === 'admin') {
       <p><mat-icon>info</mat-icon> Admins automatically have access to all guilds.</p>
    } @else {
        @if (allGuilds().length > 0) {
            <mat-selection-list formControlName="managedGuilds" class="guild-selection-list">
             @for (guildId of allGuilds(); track guildId) {
                 <mat-list-option [value]="guildId">
                    {{ guildId }}
                </mat-list-option>
            }
            </mat-selection-list>
            @if (userForm.get('managedGuilds')?.disabled) {
                <mat-hint align="start">Guild selection is disabled.</mat-hint>
            }
        } @else {
            <p>No guilds available to assign.</p>
        }
    }

  </form>

   @if (error()) {
      <p class="dialog-error-message">{{ error() }}</p>
    }

</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-stroked-button (click)="cancel()">Cancel</button>
  <button mat-flat-button color="primary" (click)="save()" [disabled]="userForm.invalid || isSaving()">
    @if (isSaving()) {
        <mat-spinner diameter="20" color="accent" style="margin-right: 8px;"></mat-spinner> Saving...
    } @else {
        Save Changes
    }
  </button>
</mat-dialog-actions>
